---
title: "Experiment A List Design"
author: "Rachel"
date: /today
geometry: margin = 2cm
header-includes:
  - /usepackage{booktabs}
  - /usepackage{siunitx}
  - /usepackage{tabto}
  - /usepackage{soul}
  - /usepackage{xcolor}
  - /usepackage{placeins}
  - /usepackage{lscape}
  - /usepackage{animate}
  - /newcommand{/blandscape}{/begin{landscape}}
  - /newcommand{/elandscape}{/end{landscape}}
  - /makeatletter/renewcommand{/fps@table}{!ht}/makeatother
  - /setstcolor{red}
  - /usepackage{sectsty}
  - /sectionfont{/color{blue}} 
  - /subsectionfont{/color{blue}}
  - /subsubsectionfont{/color{darkgray}}
output:
  pdf_document: 
    fig_caption: yes
    fig_width: 7
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
    toc: yes
    toc_depth: 4
  fontsize: 10pt
editor_options: 
  chunk_output_type: inline
---   
***
# Housekeeping   
The purpose of this file is to analyze the data collected in Experiment 1.  
_Goal:_ To determine how participant's adapted their perception to the Attended and Unattended Talkers.  
*Color file here: http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf*  
*crtl + I for reformat*   

## Knitting    
```{r Knitting, include=F}

library(knitr)

opts_chunk$set(
  dev = 'pdf',
  comment = "", 
  echo = FALSE, 
  warning = TRUE, 
  message = TRUE,
  cache = FALSE, 
  size = "small",
  tidy.opts = list(width.cutoff = 200),
  fig.width = 8, 
  fig.height = 4.5, 
  fig.align = "center")

def.chunk.hook  <- knitr::knit_hooks$get("chunk")

knitr::knit_hooks$set(
  chunk = function(x, options) {
    x <- def.chunk.hook(x, options)
    ifelse(
      options$size != "normalsize", 
      paste0(
        "/n //", 
        options$size,
        "/n/n", 
        x, 
        "/n/n //normalsize"), 
      x)
  })

color_block = function(color) {
  function(x, options)        sprintf('//color{%s}//begin{verbatim}%s//end{verbatim}//color{black}', color, x)
}
knitr::knit_hooks$set(error = color_block('red'))
knitr::knit_hooks$set(warning = color_block('orange'))
```

## Libraries   
```{r Library, include=F}
library(readr)
library(dplyr)
library(tidyverse)
library(magrittr)
library(broom)          # for extraction of coefficients
library(gganimate)      # to animate plots
library(RColorBrewer)   # to select brewer colors
library(kableExtra) 
library(lme4)
library(lmerTest)
library(ggpubr)
library(data.table)
library(jsonlite)
library(purrr)
```

```{r, Format, include=F}
options(width = 110)
theme_set(theme_bw())
```
_____
```{r}
## Altered the sortVars function to accommodate my data 
sortVars <- function(.data) {
  .data %>%
    relocate(
      ParticipantID,
      Phase,
      Block,
      Trial,
      starts_with("Item."), 
      Response,
      Response.Correct,
      Attended.Talker_Item,
      Attended.Talker_Gender,
      Attended.Talker_Ear,
      Attended.Talker_Sound,
      starts_with("Attended.Talker"),
      Unattended.Talker_Item,
      Unattended.Talker_Gender,
      Unattended.Talker_Ear,
      Unattended.Talker_Sound,
      starts_with("Unattended.Talker"),
      Filename,
      Correct_Attended.Talker,
      ExposureOrder,
      TestOrder,
      TrialOrder,
      starts_with("AttendedTalker"),
      starts_with("resp"),
      starts_with("Response"),
      starts_with("speaker_"),
      Assignment.Comment,
      starts_with("Participant."), 
      starts_with("audio_"),
      starts_with("Duration"),
      starts_with("Time"),
      starts_with("Assignment.Submit"),
      userDateTimeAtSubmit,
      userDateTimeAtInitialization,
      userAgent,
      word_recall,
      participant_id,
      everything())
}
```

# Reformat Raw Data  
```{r data}
experiment = "experiment.a"
  read_csv(
    "C:/Users/Rachel/Documents/SI.SP/data/experiment.a/Exp.1_raw.csv",
    show_col_types = FALSE) %>%

formatData(experiment) %>%
sortVars() %>%
  view()
  # write.csv(., "C:/Users/Rachel/Documents/SI.SP/data/experiment.a/Exp.1_data.csv")
```

_____

```{r store data}
data <- read_csv("C:/Users/Rachel/Documents/SI.SP/data/experiment.a/Exp.1_data.csv",
    show_col_types = FALSE)
```

# Check  
## Have any participants completed the experiment more than once?  
```{r}
data %>%
  group_by(ParticipantID, userDateTimeAtInitialization) %>%
  summarise() %>%
  group_by(ParticipantID) %>%
  tally() %>% 
  filter(n != 1)
```

## Are there the right number of Blocks?  
```{r Check number of blocks}
data %>%
  group_by(ParticipantID, Block) %>%
  summarise() %>%   
  tally() %>%
  group_by(ParticipantID) %>%
 filter(n != 23)
```

## Are there the right number of trials per block?   
### Exposure Block (8)  
```{r Exposure Trial #}
data %>%
  group_by(ParticipantID, Phase, Block, Trial) %>%
  summarise() %>% 
  filter(Block != 1) %>%
  tally() %>%
  filter(Phase == "Exposure") %>%
  filter(n != 8)
```

#### 2 Critical Items and 6 Filler Items / Exposure Block  
```{r Correct # of Filler and Critical trials per exposure block}
data %>%
  group_by(ParticipantID, Phase, Block, Item.Type, Trial) %>%
  summarise() %>%   
  tally() %>%
  filter(Phase == "Exposure") %>%
  filter(Item.Type == "Critical" & n != 2 | 
         Item.Type == "Filler" & n != 6)
```

### Test Block (6)  
```{r Test Trial #}
data %>%
  group_by(ParticipantID, Phase, Block, Trial) %>%
  summarise() %>% 
  filter(Block != 1) %>%
  tally() %>%
  filter(Phase == "Test") %>%
  filter(n != 6)
``` 

#### All Test Items / Test Block  
```{r Correct trials/# Test trials per test block}
data %>%
  group_by(ParticipantID, Phase, Block, Item.Type, Trial) %>%
  summarise() %>%   
  tally() %>%
  filter(Phase == "Test") %>%
  filter(Item.Type == "Test" & n !=  6)
```

# Exclusions    
## Survey Qs  
### Reported Attended Talker  
```{r Attended Talker Check}
# Reported Attending to the wrong talker
data %>%
  group_by(ParticipantID, Phase, Correct_Attended.Talker) %>%
  filter(Phase == "Exposure") %>%
  filter(Correct_Attended.Talker != "TRUE") %>%
  tally() %>%
  summarize() 

## 1 participant (P.533) excluded due to incorrectly responding which talker they were attending to during the exposure phase
data.A <- data %>%
    group_by(ParticipantID, Phase, Correct_Attended.Talker) %>%
    filter(Phase == "Exposure") %>%
    filter(Correct_Attended.Talker != "FALSE") %>%
    ungroup()

data.A
```

### Reported Equipment
```{r Equipment Check}
# Reported using incorrect equipment 
data.A %>%
  group_by(ParticipantID, audio_type) %>%
  filter(audio_type != "in-ear") %>%
  filter(audio_type != "over-ear") %>%
  summarise()

## 1 participant (P. 454) excluded due to reporting they used external laptop speakers during the experiment
data.B <- data.A %>%
  group_by(ParticipantID, audio_type) %>%
  filter(audio_type != "computer speakers") %>%
  ungroup()

data.B
```

## Number of Incorrect Responses  
```{r Incorrect Responses}
data.B %>%
  group_by(ParticipantID, Phase, Response.Correct) %>%
  filter(Phase == "Exposure") %>%  ## Remove the practice trials
  filter(Response.Correct == "FALSE") %>%
  tally() %>%
  ungroup()

## 59 of the remaining 62 participants answered at least 1 question incorrectly
```

### Unshifted Critical Items + Filler Items  
```{r Correct Response Check}
# Correct Responses to the filler items and the unshifted filler items
Resp_False <- data.B %>%
  group_by(ParticipantID, Phase, Response.Correct) %>%
  filter(Phase == "Exposure") %>%  ## Remove the practice trials
  filter(Attended.Talker_Version == "Unshifted" | Item.Type == "Filler") %>%
  filter(Response.Correct == "FALSE") %>%
  tally()

Resp_False

Resp_False_Max <- 0.15 * 70   # Number of trials can get incorrect; 80% correct (incorrect responses =< 10.5)
                              # 70 because 80 Exposure trials - 10 Critical Shifted Items

Resp_False %>%
  filter(n >= Resp_False_Max)

## Remove P. 461, P.467, and P.549 for # of incorrect responses 
data.C <- data.B %>%
  group_by(ParticipantID) %>% 
  filter(ParticipantID != 461) %>%
  filter(ParticipantID != 467) %>%
  filter(ParticipantID != 549) %>%
  ungroup()

data.C
```

### Critical Shifted Items
```{r Incorrect Response: Shifted}
# Correct Responses for the shifted critical items (X > 6)
Crit.Resp_False <- data.C %>%
  group_by(ParticipantID, Item.Type, Attended.Talker_Version, Response.Correct) %>%
  filter(Item.Type == "Critical") %>% 
  filter(Attended.Talker_Version == "Shifted") %>%
  filter(Response.Correct == "FALSE") %>%
  tally()

Crit.Resp_False

Crit.Resp_False_Max <- 4 
# 10 shifted critical Items; at least 6 correct; 6 correct (4 incorrect) is likely the lowest value to still see adaptation

Crit.Resp_False %>%
  filter(n > Crit.Resp_False_Max)

## Remove P.548 for too many incorrect Critical Trials
data.D <- data.C %>%
  group_by(ParticipantID) %>% 
  filter(ParticipantID != 548) %>%
  ungroup()

data.D
```

#### Shifted S
```{r Incorrect Response: Shifted S}
# Correct Responses for the shifted S critical trials (1/2 participants) --> Compare to Sh
Crit.S.Resp_False <- data.D %>%
  group_by(ParticipantID, Item.Type, Attended.Talker_Sound, Attended.Talker_Version,  Response.Correct) %>%
  filter(Item.Type == "Critical") %>% 
  filter(Attended.Talker_Sound == "S") %>% 
  filter(Attended.Talker_Version == "Shifted") %>%
  filter(Response.Correct == "FALSE") %>%
  tally()

Crit.S.Resp_False

Crit.S.Resp_False_Max <-  5 # Half of the S shifted trials

Crit.S.Resp_False %>%
  filter(n >= Crit.S.Resp_False_Max)
```

#### Shifted Sh
```{r Incorrect Response: Shifted Sh}
# Correct Responses for the shifted Sh critical trials (1/2 participants) --> Compare to S
Crit.Sh.Resp_False <- data.D %>%
  group_by(ParticipantID, Item.Type, Attended.Talker_Sound, Attended.Talker_Version,Response.Correct) %>%
  filter(Item.Type == "Critical") %>% 
  filter(Attended.Talker_Sound == "Sh") %>%
  filter(Attended.Talker_Version == "Shifted") %>%
  filter(Response.Correct == "FALSE") %>%
  tally()

Crit.Sh.Resp_False

Crit.Sh.Resp_False_Max <- 5 # Half of the S shifted trials

Crit.Sh.Resp_False %>%
  filter(n >= Crit.Sh.Resp_False_Max) %>%
  summarise()
```

```{r Avg/sd incorrect responses}
Resp_False <- data.D %>%
  group_by(ParticipantID, Phase, Response.Correct) %>%
  filter(Phase == "Exposure") %>%  ## Remove the practice trials
  filter(Attended.Talker_Version == "Unshifted" | Item.Type == "Filler") %>%
  filter(Response.Correct == "FALSE") %>%
  tally()

Resp_False

  avg_Resp.False <- mean(Resp_False$n)
  avg_Resp.False              # Print Mean incorrect trials

  sd_Resp.False <- sd(Resp_False$n)
  sd_Resp.False

# (sd_Resp.False * 2.5) + avg_Resp.False  ## validate correct response exclusion criteria
```

# Average Participant Age
```{r age}
x <- Data %>%
  group_by(ParticipantID, Participant.Age) %>%
  filter(Participant.Age != "NA") %>%
  summarize()

mean(x$Participant.Age)
sd(x$Participant.Age)
```


# Sig. difference between Response.Correct exclusions between conditions
```{r sig diff}
## All Trial Responses
A1 <- data.C %>%  # data.C before Response.Correct exclusions
  group_by(ParticipantID, Response.Correct) %>%
  filter(Response.Correct == "FALSE") %>%
  group_by(Attended.Talker_Sound, Attended.Talker_Version) %>%
  tally() 

A2 <- data.D %>%
  group_by(ParticipantID, Response.Correct) %>%
  filter(Response.Correct == "FALSE") %>%
  group_by(Attended.Talker_Sound, Attended.Talker_Version) %>%
  tally() 

A1
A2

table(A1$n, A2$n)

chisq.test(table(A1$n, A2$n))

# Only Critical Responses, separated by sound + version
B1 <- data.C %>%  # data.C before Response.Correct exclusions
  group_by(ParticipantID, Response.Correct) %>%
  filter(Response.Correct == "FALSE") %>%
  group_by(ParticipantID, Attended.Talker_Sound, Attended.Talker_Version) %>%
  filter(Item.Type == "Critical") %>%
  group_by(Attended.Talker_Sound, Attended.Talker_Version) %>%
  tally() 

B2 <- data.D %>%  
  group_by(ParticipantID, Response.Correct) %>%
  filter(Response.Correct == "FALSE") %>%
  group_by(ParticipantID, Attended.Talker_Sound, Attended.Talker_Version) %>%
  filter(Item.Type == "Critical") %>%
  group_by(Attended.Talker_Sound, Attended.Talker_Version) %>%
  tally()

B1
B2

table(B1$n, B2$n)

chisq.test(table(B1$n, B2$n))

# Only Critical Responses, separated by Gender
C1 <- data.C %>%  # data.C before Response.Correct exclusions
  group_by(ParticipantID, Response.Correct) %>%
  filter(Response.Correct == "FALSE") %>%
  group_by(ParticipantID, Attended.Talker_Sound, Attended.Talker_Version, Attended.Talker_Gender) %>%
  filter(Item.Type == "Critical") %>%
  group_by(Attended.Talker_Gender) %>%
  tally()

C2 <- data.D %>%  
  group_by(ParticipantID, Response.Correct) %>%
  filter(Response.Correct == "FALSE") %>%
  group_by(ParticipantID, Attended.Talker_Sound, Attended.Talker_Version, Attended.Talker_Gender) %>%
  filter(Item.Type == "Critical") %>%
  group_by(Attended.Talker_Gender) %>%
  tally()

C1
C2

table(C1$n, C2$n)

chisq.test(table(C1$n, C2$n))

# No statistical sig. diff (P > .05) between how exclusion criteria applied to participants across conditions 

## DOuble check this is actually functioning as intended
```

# Plot data  
## Divide panes by *Attended Talker* and *Unattended Talker*   
### Curve for ?s (more Ashi) and curve for ?sh (more Asi) 
### y = proportion of ASHI (~25% - ~75%); x = ashi.08 -> ashi.19 (6 step cont.: 08, 12, 13, 14, 15, 19)  
```{r}
data %>%
  group_by(ParticipantID) %>%
   filter(ParticipantID != 461) %>%
   filter(ParticipantID != 467) %>%
   filter(ParticipantID != 549) %>%
   filter(ParticipantID != 533) %>%
   filter(ParticipantID != 454) %>%
 
  mutate(AttendedTalkerGender = case_when(
    AttendedTalkerGender == "F" ~ "Female",
    AttendedTalkerGender == "M" ~ "Male",
    T ~ "NA"
  )) %>%
  
   select(-c("...1")) %>%
 write.csv(., "C:/Users/Rachel/Documents/SI.SP/data/experiment.a/Exp.1_clean.csv", row.names = FALSE)
```

```{r}
Data <- read_csv("C:/Users/Rachel/Documents/SI.SP/data/experiment.a/Exp.1_clean.csv",
    show_col_types = FALSE)
```

```{r, fig.width=6, fig.height=5, warning=FALSE, fig.cap=""}
Data %>%                           
  group_by(ParticipantID, 
           Item.Type,
           AttendedTalkerGender,
           Attended.Talker_Item,
           Attended.Talker_Gender, 
           Attended.Talker_Sound,
           Attended.Talker_Version
           ) %>%
  
  filter(Item.Type == "Test") %>%    
 
# Will be covered by the aggregate function 
  # Attended.Resp <-
  ## filter(Attended.Talker_Gender == AttendedTalkerGender)
  ## group_by(Attended.talker_Sound, Attended.Talker_Version)

  # Unattended.Resp <- 
  ## filter(Attended.Talker_Gender != AttendedTalkerGender)
  ## group_by(Attended.talker_Sound, Attended.Talker_Version)
  
# Also need a within-group comparison by shift (?s/?sh) ?
  # Attended.Resp <-
  ## filter(Attended.Talker_Gender == AttendedTalkerGender)
  ## group_by(Attended.talker_Sound, Attended.Talker_Version)  
  ## group_by(Attended.talker_version) ?


  mutate(Response.Ashi = ifelse(Response == "ASHI", 1, 0)) %>%
  
  # tally() %>%        # Check the correct # of observations
  # filter (n != 6)  
  
  ggplot(aes(
    x = Attended.Talker_Item, 
    y = Response.Ashi)) +
 
 geom_smooth(
    method = "glm",
    formula = y ~ x, 
    method.args = list(family = "binomial"),
    show.legend = TRUE) +
 
  ## Graph info   
  ggtitle("Attended Talker/Unattended Talker") +
   scale_x_discrete("ASHI Item (ASI -> ASHI)") +
   scale_y_continuous("Proportion of ASHI Responses (%)",
  limits = c(0,1)) +
  theme(legend.position = "top")
```



 



